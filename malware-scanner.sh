#!/bin/bash

COUNTER=1

# Our IP - 88.97.74.223
# Honey Pot IP - 192.42

while [ $COUNTER -le 5 ]
	do
date
echo "Running..." && echo
sleep 1

echo "Checking for active connections from bad IP and finding PID..." && echo
# PID=$(lsof -i @88.97.74.223 | awk '{print $2}' | sed /PID/d | head -n 1)


PIDS=($(lsof -i -n | grep "192.42" | awk '{print $2}' | sed /PID/d))
ps aux | grep "${PIDS[0]}" | head -n 1 > /tmp/malware-scan-results.txt

if [ -s /tmp/malware-scan-results.txt ]
	then
		for PID in "${PIDS[@]}"; do
			echo "PID $PID:" >> /tmp/malware-scan-results.txt
			ls -l /proc/$PID/fd >> /tmp/malware-scan-results.txt
		done
fi

if [ -f /tmp/malware-scan-results.txt ]
    then
	echo "If no results - Removing Headers from file..." && echo
	cat /tmp/malware-scan-results.txt | sed -i '/USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND/d' /tmp/malware-scan-results.txt
	cat /tmp/malware-scan-results.txt | sed -i '/USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND/d' /tmp/malware-scan-results.txt

		if [ `cat /tmp/malware-scan-results.txt | wc -w` -gt 1 ]
			then
				echo "File probably contained a result, word count was greater than 1" && echo
				echo "Sending Email..." && echo
        			cat /tmp/malware-scan-results.txt | mail -s "Malicious Connection Detected on $HOSTNAME" support@cloudabove.com
		
				echo "Increasing Counter by +1" && echo
				((COUNTER++))
		fi
fi

done

echo "Removing /tmp/malware-scan-results.txt" && echo
rm -f /tmp/malware-scan-results.txt
